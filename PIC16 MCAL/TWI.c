/* ////////////////////////////////////////////////////////////////////////////////////////////////////
Name: Eslam Aboutaleb
File: TWI.h
Date: 4/7/2020
//////////////////////////////////////////////////////////////////////////////////////////////////// */
#include "Main.h"
#include "Port.h"
#include "TWI.h"

/*////////////////////////////////////////////////////////////////////////////////////// */
/*Initializes I2C*/
/*////////////////////////////////////////////////////////////////////////////////////// */
void I2C_Master_Init(const tWord32 baud)
{
  /*Enable SDA and SCL*/
  /*I2C Master mode, clock = FOSC/(4 * (SSPADD + 1))*/
  SSPCON = 0x28;
  SSPCON2 = 0;
  /*Assign the clock*/
  SSPADD = (_XTAL_FREQ/(4*baud))-1;
  SSPSTAT = 0;
  /*Make SDA & SCL pins inputs*/
  TRISC3 = 1;
  TRISC4 = 1;
}

/*////////////////////////////////////////////////////////////////////////////////////// */
/*I2C wait*/
/*////////////////////////////////////////////////////////////////////////////////////// */
void I2C_Master_Wait(void)
{
  CHECK_I2C_BUSY_WAIT();
}

/*I2C Start*/
void I2C_Master_Start(void)
{
  I2C_Master_Wait();

  SEN = 1;
}

/*////////////////////////////////////////////////////////////////////////////////////// */
/*I2C repeated start*/
/*////////////////////////////////////////////////////////////////////////////////////// */
void I2C_Master_RepeatedStart(void)
{
  I2C_Master_Wait();

  RSEN = 1;
}

/*////////////////////////////////////////////////////////////////////////////////////// */
/*I2C Stop*/
/*////////////////////////////////////////////////////////////////////////////////////// */
void I2C_Master_Stop(void)
{
  I2C_Master_Wait();

  PEN = 1;
}

/*////////////////////////////////////////////////////////////////////////////////////// */
/*I2C ACK*/
/*////////////////////////////////////////////////////////////////////////////////////// */
void I2C_ACK(void)
{
  ACKDT = 0; // 0 -> ACK

  I2C_Master_Wait();

  ACKEN = 1; // Send ACK
}

/*////////////////////////////////////////////////////////////////////////////////////// */
/*I2C NACK*/
/*////////////////////////////////////////////////////////////////////////////////////// */
void I2C_NACK(void)
{
  ACKDT = 1; // 1 -> NACK

  I2C_Master_Wait();

  ACKEN = 1; // Send NACK
}

/*////////////////////////////////////////////////////////////////////////////////////// */
/*I2C write*/
/*////////////////////////////////////////////////////////////////////////////////////// */
tByte I2C_Master_Write(tByte data)
{
  I2C_Master_Wait();
  /*Assign data to before*/
  SSPBUF = data;

  while(!SSPIF); /* Wait Until Completion*/

  I2C_CLEAR_INTERRUPT();
  /*Return ACK state*/
  return ACKSTAT;
}

/*////////////////////////////////////////////////////////////////////////////////////// */
/*I2C Read*/
/*////////////////////////////////////////////////////////////////////////////////////// */
tWord I2C_Master_Read(tWord a)
{
 tWord temp;

 I2C_Master_Wait();
 /*Enable receiving*/
 I2C_EN_RECV();

 I2C_Master_Wait();
 /*Read the buffer*/
 temp = SSPBUF;

 I2C_Master_Wait();
 /* if a == 1 then it reads with ack*/
 ACKDT = (a)?0:1;
 ACKEN = 1;
 /*Return the data*/
 return temp;
}
